# 稳定性保持系统部署指南

## 1. 概述

本文档提供了稳定性保持系统的详细部署和配置说明。稳定性保持系统是一套用于工业环境的PLC通信与控制软件，通过Modbus TCP协议与PLC设备进行通信，并提供RESTful API接口供上层应用调用。

## 2. 系统要求

### 2.1 硬件要求

- **处理器**：Intel Core i3 或同等性能的处理器（推荐 i5 或更高）
- **内存**：最小 2GB RAM（推荐 4GB 或更高）
- **存储**：至少 100MB 可用空间
- **网络**：稳定的网络连接，能够与PLC设备通信

### 2.2 软件要求

- **开发环境**：
  - 操作系统：Windows 11
  - IDE：Visual Studio 2022
  - 依赖库：
    - cpprestsdk 2.10.19 (x64-linux)
    - nlohmann-json 3.11.3 (x64-linux)
    - spdlog 1.9.2
    - fmt 9.1.0
    - libmodbus 3.1.10

- **运行环境**：
  - 操作系统：Ubuntu Server 24.04
  - 包管理器：vcpkg
  - 依赖软件：
    - libmodbus 3.1.10
    - OpenSSL 1.1.1+
    - Boost 1.66+（支持C++ REST SDK）
    - cpprestsdk 2.10.19
    - nlohmann-json 3.11.3
    - spdlog 1.9.2
    - fmt 9.1.0
- **网络环境**：支持TCP/IP协议，与PLC设备在同一网段或有路由可达

## 3. 安装步骤

### 3.1 准备工作

1. 确认PLC设备已正确配置，并记录其IP地址和端口号
2. 确认部署环境满足上述系统要求
3. 下载最新版本的稳定性保持系统安装包

### 3.2 安装依赖项

1. 安装 libmodbus 库
   ```bash
   # Ubuntu Server 24.04
   sudo apt-get update
   sudo apt-get install -y libmodbus-dev
   ```

2. 安装 OpenSSL
   ```bash
   sudo apt-get install -y libssl-dev
   ```

3. 安装 Boost
   ```bash
   sudo apt-get install -y libboost-all-dev
   ```

4. 安装 C++ REST SDK 和 JSON 库
   ```bash
   # 使用vcpkg安装
   vcpkg install cpprestsdk:x64-linux
   vcpkg install nlohmann-json:x64-linux
   ```

5. 安装 spdlog 和 fmt
   ```bash
   # 从源码编译安装
   git clone https://github.com/gabime/spdlog.git
   cd spdlog
   git checkout v1.9.2
   make
   sudo make install

   git clone https://github.com/fmtlib/fmt.git
   cd fmt
   git checkout 9.1.0
   make
   sudo make install
   ```

### 3.3 配置文件说明

系统使用INI格式的配置文件（`config/config.ini`）进行配置，主要包含以下部分：

1. 服务器配置（[server]）
   - port：HTTP服务器监听端口，默认8080
   - host：服务器监听地址，默认0.0.0.0（监听所有接口）

2. PLC配置（[plc]）
   - ip：PLC设备IP地址，需要根据实际环境配置
   - port：PLC设备Modbus TCP端口，默认502

3. 日志配置（[logging]）
   - level：日志级别，可选值：trace, debug, info, warning, error, critical，默认info

配置文件示例：
```ini
[server]
port = 8080              # API 服务监听端口
host = 0.0.0.0           # API 服务监听地址，0.0.0.0表示监听所有接口

[plc]
ip = 192.168.1.10        # PLC设备IP地址
port = 502               # PLC设备Modbus TCP端口

[logging]
level = info             # 日志级别：trace, debug, info, warning, error, critical
```

注意事项：
1. 配置文件支持注释，使用#或;开头
2. 支持空行，提高可读性
3. 如果配置文件不存在或加载失败，系统将使用默认配置
2. 确保解压后的目录结构如下：
   ```
   /opt/stability/
   ├── bin/
   │   └── stability_server
   ├── config/
   │   ├── config.ini
   │   └── logging.conf
   ├── lib/
   │   └── ... (可能包含一些特定版本的库)
   ├── scripts/
   │   ├── install_service.sh
   │   └── uninstall_service.sh
   └── docs/
       ├── README.md
       └── API接口文档.md
   ```

3. 配置系统服务

   运行以下命令安装系统服务：
   ```bash
   cd /opt/stability/scripts
   sudo chmod +x install_service.sh
   sudo ./install_service.sh
   ```

## 4. 配置系统

### 4.1 配置管理类

系统使用`ConfigManager`类统一管理配置，该类采用单例模式设计，确保全局只有一个配置实例。主要功能包括：

1. **配置加载**：
   - 支持从INI格式的配置文件加载配置
   - 支持注释（以#开头）和空行
   - 自动去除键值对的首尾空格
   - 配置文件不存在时使用默认配置

2. **配置项**：
   - 服务器配置：监听地址、端口
   - PLC配置：设备IP地址、Modbus TCP端口
   - 日志配置：日志级别

3. **使用方式**：
   ```cpp
   // 获取配置管理器实例
   auto& config = ConfigManager::instance();
   
   // 加载配置文件
   config.load_config("config/config.ini");
   
   // 获取配置项
   std::string server_host = config.get_server_host();
   int server_port = config.get_server_port();
   std::string plc_ip = config.get_plc_ip();
   int plc_port = config.get_plc_port();
   std::string log_level = config.get_log_level();
   ```

### 4.2 基本配置

编辑 `config/config.ini` 文件，根据实际环境配置以下参数：

```ini
[server]
port = 8080              # API 服务监听端口
host = 0.0.0.0           # API 服务监听地址，0.0.0.0表示监听所有接口
worker_threads = 4       # 工作线程数
timeout_ms = 5000        # 请求超时时间（毫秒）

[plc]
ip = 192.168.1.10        # PLC设备IP地址
port = 502               # PLC设备Modbus TCP端口
retry_count = 3          # 通信失败重试次数
retry_interval_ms = 1000 # 重试间隔（毫秒）
read_timeout_ms = 1000   # 读取超时时间（毫秒）

[callback]
url = http://edge-platform  # 信息平台基础URL
retry_count = 3          # 回调失败重试次数
retry_interval_ms = 5000 # 回调重试间隔（毫秒）

[logging]
level = info             # 日志级别：trace, debug, info, warning, error, critical
file = logs/stability.log # 日志文件路径
max_size = 10485760      # 单个日志文件最大尺寸（字节）
max_files = 10           # 最大保留日志文件数
```

### 4.3 日志配置

编辑 `config/logging.conf` 文件，可以进一步自定义日志配置：

```ini
[general]
# 日志格式
pattern = [%Y-%m-%d %H:%M:%S.%e] [%l] [%t] %v
# 是否显示在控制台
console = true
# 是否写入文件
file = true

[file]
# 日志文件路径（相对于程序根目录）
path = logs/stability.log
# 单个日志文件最大尺寸（MB）
max_size = 10
# 最大保留文件数
max_files = 10
# 是否使用日期作为文件名后缀
use_date = true
# 日期格式（用于文件名）
date_format = %Y%m%d
```

### 4.4 安全配置

如果需要开启基本认证和IP白名单，请在 `config/config.ini` 文件中添加以下部分：

```ini
[security]
# 是否启用基本认证
basic_auth = true
# 用户名
username = admin
# 密码（建议使用加密后的形式）
password = your_secure_password
# 是否启用IP白名单
ip_whitelist = true
# 允许访问的IP地址列表，用逗号分隔
allowed_ips = 127.0.0.1,192.168.1.0/24
```

## 5. 启动系统

### 5.1 作为服务运行（推荐）

如果在安装步骤中已注册为系统服务，可通过以下方式管理：

1. 启动服务：
   ```bash
   sudo systemctl start stability
   ```

2. 停止服务：
   ```