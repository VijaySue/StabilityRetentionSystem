# 稳定性保持系统部署指南

## 1. 概述

本文档提供了稳定性保持系统的详细部署和配置说明。稳定性保持系统是一套用于工业环境的PLC通信与控制软件，通过Modbus TCP协议与PLC设备进行通信，并提供RESTful API接口供上层应用调用。

## 2. 系统要求

### 2.1 硬件要求

- **处理器**：Intel Core i3 或同等性能的处理器（推荐 i5 或更高）
- **内存**：最小 2GB RAM（推荐 4GB 或更高）
- **存储**：至少 100MB 可用空间
- **网络**：稳定的网络连接，能够与PLC设备通信

### 2.2 软件要求

- **操作系统**：Linux（Ubuntu 18.04+ / CentOS 7+）
- **依赖软件**：
  - libmodbus 3.1.6+ 库
  - OpenSSL 1.1.1+
  - Boost 1.66+（支持C++ REST SDK）
- **网络环境**：支持TCP/IP协议，与PLC设备在同一网段或有路由可达

## 3. 安装步骤

### 3.1 准备工作

1. 确认PLC设备已正确配置，并记录其IP地址和端口号
2. 确认部署环境满足上述系统要求
3. 下载最新版本的稳定性保持系统安装包

### 3.2 安装依赖项

1. 安装 libmodbus 库
   ```bash
   # Ubuntu/Debian
   sudo apt-get update
   sudo apt-get install -y libmodbus-dev
   
   # CentOS/RHEL
   sudo yum install -y epel-release
   sudo yum install -y libmodbus-devel
   ```

2. 安装 OpenSSL
   ```bash
   # Ubuntu/Debian
   sudo apt-get install -y libssl-dev
   
   # CentOS/RHEL
   sudo yum install -y openssl-devel
   ```

3. 安装 Boost
   ```bash
   # Ubuntu/Debian
   sudo apt-get install -y libboost-all-dev
   
   # CentOS/RHEL
   sudo yum install -y boost-devel
   ```

4. 安装 C++ REST SDK
   ```bash
   # Ubuntu/Debian
   sudo apt-get install -y libcpprest-dev
   
   # CentOS/RHEL
   # 对于CentOS，可能需要从源码编译
   git clone https://github.com/Microsoft/cpprestsdk.git
   cd cpprestsdk
   git submodule update --init
   # 使用Make进行编译安装
   make
   sudo make install
   ```

### 3.3 安装系统

1. 解压安装包到指定目录，例如 `/opt/stability`

2. 确保解压后的目录结构如下：
   ```
   /opt/stability/
   ├── bin/
   │   └── stability_server
   ├── config/
   │   ├── config.ini
   │   └── logging.conf
   ├── lib/
   │   └── ... (可能包含一些特定版本的库)
   ├── scripts/
   │   ├── install_service.sh
   │   └── uninstall_service.sh
   └── docs/
       ├── README.md
       └── API接口文档.md
   ```

3. 配置系统服务

   运行以下命令安装系统服务：
   ```bash
   cd /opt/stability/scripts
   sudo chmod +x install_service.sh
   sudo ./install_service.sh
   ```

## 4. 配置系统

### 4.1 基本配置

编辑 `config/config.ini` 文件，根据实际环境配置以下参数：

```ini
[server]
port = 8080              # API 服务监听端口
host = 0.0.0.0           # API 服务监听地址，0.0.0.0表示监听所有接口
worker_threads = 4       # 工作线程数
timeout_ms = 5000        # 请求超时时间（毫秒）

[plc]
ip = 192.168.1.10        # PLC设备IP地址
port = 502               # PLC设备Modbus TCP端口
retry_count = 3          # 通信失败重试次数
retry_interval_ms = 1000 # 重试间隔（毫秒）
read_timeout_ms = 1000   # 读取超时时间（毫秒）

[callback]
url = http://edge-platform  # 信息平台基础URL
retry_count = 3          # 回调失败重试次数
retry_interval_ms = 5000 # 回调重试间隔（毫秒）

[logging]
level = info             # 日志级别：trace, debug, info, warning, error, critical
file = logs/stability.log # 日志文件路径
max_size = 10485760      # 单个日志文件最大尺寸（字节）
max_files = 10           # 最大保留日志文件数
```

### 4.2 日志配置

编辑 `config/logging.conf` 文件，可以进一步自定义日志配置：

```ini
[general]
# 日志格式
pattern = [%Y-%m-%d %H:%M:%S.%e] [%l] [%t] %v
# 是否显示在控制台
console = true
# 是否写入文件
file = true

[file]
# 日志文件路径（相对于程序根目录）
path = logs/stability.log
# 单个日志文件最大尺寸（MB）
max_size = 10
# 最大保留文件数
max_files = 10
# 是否使用日期作为文件名后缀
use_date = true
# 日期格式（用于文件名）
date_format = %Y%m%d
```

### 4.3 安全配置

如果需要开启基本认证和IP白名单，请在 `config/config.ini` 文件中添加以下部分：

```ini
[security]
# 是否启用基本认证
basic_auth = true
# 用户名
username = admin
# 密码（建议使用加密后的形式）
password = your_secure_password
# 是否启用IP白名单
ip_whitelist = true
# 允许访问的IP地址列表，用逗号分隔
allowed_ips = 127.0.0.1,192.168.1.0/24
```

## 5. 启动系统

### 5.1 作为服务运行（推荐）

如果在安装步骤中已注册为系统服务，可通过以下方式管理：

1. 启动服务：
   ```bash
   sudo systemctl start stability
   ```

2. 停止服务：
   ```bash
   sudo systemctl stop stability
   ```

3. 查看服务状态：
   ```bash
   sudo systemctl status stability
   ```

4. 设置开机自启：
   ```bash
   sudo systemctl enable stability
   ```

### 5.2 直接运行

也可以直接运行可执行文件：

1. 进入程序目录：
   ```bash
   cd /opt/stability/bin
   ```

2. 给予执行权限（如果尚未设置）：
   ```bash
   chmod +x stability_server
   ```

3. 运行程序：
   ```bash
   ./stability_server
   ```

4. 如需在后台运行：
   ```bash
   ./stability_server > /dev/null 2>&1 &
   ```

## 6. 系统验证

安装完成后，可通过以下方式验证系统是否正常运行：

### 6.1 检查服务状态

如果配置为系统服务，执行以下命令检查状态：

```bash
sudo systemctl status stability
```

应当看到类似以下输出：

```
● stability.service - Stability Retention System
   Loaded: loaded (/etc/systemd/system/stability.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2024-01-01 12:00:00 CST; 10s ago
 Main PID: 12345 (stability_server)
    Tasks: 5 (limit: 4915)
   CGroup: /system.slice/stability.service
           └─12345 /opt/stability/bin/stability_server
```

### 6.2 检查API访问

使用curl命令测试API接口：

```bash
curl -X GET http://localhost:8080/api/v1/system/health
```

如果系统正常运行，应当返回类似以下JSON响应：

```json
{
  "status": "OK",
  "version": "2.0.0",
  "timestamp": 1684123456789
}
```

### 6.3 检查PLC连接

测试系统状态接口，验证与PLC的连接：

```bash
curl -X GET http://localhost:8080/api/v1/system/status
```

如果PLC连接正常，应当返回类似以下JSON响应：

```json
{
  "status": "OK",
  "plcConnected": true,
  "systemMode": "auto",
  "platformStatus": {
    "platform1": {
      "height": 120,
      "state": "stopped"
    },
    "platform2": {
      "height": 150,
      "state": "stopped"
    }
  },
  "timestamp": 1684123456789
}
```

## 7. 常见问题

### 7.1 系统无法启动

- 检查日志文件 `/opt/stability/logs/stability.log` 查看详细错误信息
- 确认所有依赖项已正确安装
- 确认配置文件中的参数正确无误
- 确认程序有执行权限

### 7.2 无法连接到PLC

- 检查PLC设备是否正常运行
- 验证PLC的IP地址和端口号配置是否正确
- 使用工具（如ping）测试网络连通性
- 检查防火墙配置，确保允许相关端口的通信

### 7.3 API请求超时

- 检查系统负载情况
- 增加配置文件中的超时时间
- 如使用反向代理，确认代理配置中的超时设置合理
- 优化PLC通信参数，减少响应时间

## 8. 系统维护

### 8.1 备份配置

定期备份系统配置文件：

```bash
sudo cp -r /opt/stability/config /path/to/backup/config_$(date +%Y%m%d)
```

### 8.2 日志管理

系统日志位于 `/opt/stability/logs/` 目录，定期检查或通过logrotate进行管理。

### 8.3 系统升级

1. 停止服务：
   ```bash
   sudo systemctl stop stability
   ```

2. 备份当前版本：
   ```bash
   sudo cp -r /opt/stability /opt/stability_backup_$(date +%Y%m%d)
   ```

3. 更新文件：
   ```bash
   # 解压新版本至临时目录
   tar -xzf stability-new-version.tar.gz -C /tmp
   
   # 替换可执行文件和库文件
   sudo cp -f /tmp/stability/bin/* /opt/stability/bin/
   sudo cp -f /tmp/stability/lib/* /opt/stability/lib/
   
   # 保留原有配置
   # 仅在配置格式变更时更新配置文件
   ```

4. 启动服务：
   ```bash
   sudo systemctl start stability
   ```

## 9. 安全建议

- 定期更改管理员密码
- 启用API访问限制，设置IP白名单
- 将系统部署在安全的内部网络，避免直接暴露在公网
- 限制系统用户的权限，仅授予必要的访问权限
- 定期更新系统和依赖库，修补安全漏洞

## 10. 参考资料

- [libmodbus 官方文档](https://libmodbus.org/docs/)
- [C++ REST SDK 文档](https://github.com/microsoft/cpprestsdk)
- [Modbus 协议规范](https://modbus.org/specs.php)
- [PLC Siemens S7 通信指南](https://support.industry.siemens.com/cs/document/26999692/modbus-tcp-communication-with-s7-1200-s7-1500-?dti=0&lc=en-WW)
- [Systemd 服务配置文档](https://www.freedesktop.org/software/systemd/man/systemd.service.html)

## 11. 联系与支持

如有任何问题，请联系系统管理员或技术支持团队：

- 电子邮件：vijaysue@yeah.net
- 电话：+86-13141033396
- 工作时间：周一至周五 9:00-18:00 