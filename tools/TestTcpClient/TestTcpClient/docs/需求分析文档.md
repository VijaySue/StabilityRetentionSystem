# 稳定性保持系统需求分析文档

## 1. 系统概述

稳定性保持系统是一套专门用于控制稳定平台的自动化系统，通过PLC设备与液压系统和传感器集成，实现平台的升降、水平调整和刚柔支撑等功能，可广泛应用于精密设备支撑、实验平台稳定控制等领域。

本系统提供基于HTTP的API接口，允许上层应用通过网络远程控制平台操作，同时可以查询平台当前状态和运行参数。系统还实现了异步任务管理，确保长时间运行的操作能够被跟踪和管理。

## 2. 主要功能需求

### 2.1 设备状态监控

1. **平台状态实时监控**
   - 系统能够实时监控平台工作状态，包括：
     - 升降平台1和升降平台2的状态（上升、上升停止、下降、下降停止）
     - 刚柔缸状态（下降停止、下降加压、上升停止、上升）
     - 油泵、电加热、风冷等辅助设备状态
     - 平台倾斜角度和位置信息

2. **压力和位置参数监控**
   - 实时监控各关键部件的压力值：
     - 刚柔缸压力值
     - 升降平台1和升降平台2压力值
   - 监控平台位置和倾角参数

3. **报警状态监控**
   - 实时监控系统可能出现的报警状态：
     - 油温低/高报警
     - 液位低/高报警
     - 滤芯堵塞报警

### 2.2 平台控制功能

1. **支撑控制功能**
   - 刚性支撑：控制刚柔缸下降并加压，实现刚性支撑
   - 柔性复位：控制刚柔缸上升，实现柔性复位

2. **平台高度控制**
   - 支持独立控制升降平台1和升降平台2：
     - 平台上升：控制指定平台上升，达到预设压力自动停止
     - 平台下降：控制指定平台下降，到达底部位置自动停止

3. **平台水平调整**
   - 支持自动调平功能：通过电动缸调整平台水平度
   - 支持调平停止：随时可停止调平过程

4. **电源控制功能**
   - 支持远程开启/关闭系统电源

5. **电机控制功能**
   - 支持远程启动/停止油泵电机

6. **操作模式切换**
   - 支持自动/手动模式切换

### 2.3 API接口需求

1. **系统状态查询接口**
   - 提供HTTP接口，返回系统当前状态的完整信息
   - 状态信息包含所有设备状态、压力、位置等参数

2. **控制指令接口**
   - 支撑控制：接收刚性支撑/柔性复位指令
   - 平台高度控制：接收平台上升/下降指令
   - 平台调平控制：接收调平启动/停止指令
   - 电源控制：接收电源开启/关闭指令
   - 电机控制：接收电机启动/停止指令
   - 操作模式：接收自动/手动模式切换指令

3. **错误上报接口**
   - 提供错误上报功能，允许客户端向系统报告错误信息

### 2.4 任务管理需求

1. **异步任务处理**
   - 对于耗时较长的操作（如平台升降、调平等），采用异步任务方式处理
   - 每个任务分配唯一的taskId，可用于跟踪任务进度

2. **任务状态查询**
   - 提供查询特定任务执行状态的接口
   - 任务状态包括：等待执行、执行中、已完成、执行失败等

### 2.5 安全性需求

1. **输入验证**
   - 对所有API输入进行严格验证，确保参数完整性和有效性
   - 对非法输入返回明确的错误信息

2. **异常处理**
   - 系统能够优雅处理各类异常情况，包括：
     - PLC通信异常
     - 设备操作异常
     - 非法参数请求
   - 所有异常都记录详细日志，并返回适当的错误响应

3. **紧急停止功能**
   - 支持紧急停止所有操作的功能
   - 紧急停止后，系统进入安全状态

## 3. 非功能性需求

### 3.1 性能需求

1. **响应时间**
   - API接口响应时间不超过500ms（不包括实际操作执行时间）
   - 状态查询接口响应时间不超过200ms

2. **并发处理**
   - 系统能够同时处理至少10个并发请求
   - 任务管理器能够并行管理至少20个异步任务

3. **可用性**
   - 系统连续运行时间应达到99.9%
   - 系统重启后能够在30秒内恢复服务

### 3.2 可靠性需求

1. **故障恢复**
   - 当PLC通信中断后，系统能够自动尝试重连
   - 系统崩溃后能够恢复到安全状态

2. **数据一致性**
   - 确保系统状态数据与实际设备状态保持一致
   - 提供数据验证机制，检测异常数据

### 3.3 可维护性需求

1. **日志系统**
   - 系统运行日志分级记录（DEBUG, INFO, WARN, ERROR, FATAL）
   - 记录所有API调用、PLC通信和异常情况
   - 日志自动轮转，防止日志文件过大

2. **配置灵活性**
   - 关键参数可通过配置文件调整，无需重新编译
   - 配置项包括：服务器端口、PLC连接参数、日志级别等

### 3.4 部署需求

1. **开发环境**
   - 操作系统：Windows 11
   - 开发IDE：Visual Studio 2022
   - 构建工具：CMake
   - 包管理器：vcpkg
   - 版本控制：Git

2. **运行环境**
   - 操作系统：Ubuntu Server 24.04
   - 编译器：GCC 11+
   - 构建工具：CMake 3.20+
   - 依赖库：
     - cpprestsdk 2.10.19
     - nlohmann-json 3.11.3
     - spdlog 1.9.2
     - fmt 9.1.0
     - libmodbus 3.1.10

3. **硬件需求**
   - 最低配置：双核处理器，4GB内存，100MB存储空间
   - 建议配置：四核处理器，8GB内存，1GB存储空间

4. **网络需求**
   - 支持通过以太网与PLC设备通信
   - 支持通过HTTP协议与上层应用通信

## 4. 用户场景

### 4.1 系统启动场景

1. **系统初始化**
   - 操作员启动系统
   - 系统自动连接PLC设备
   - 系统初始化完成，进入待命状态
   - 上层应用通过状态查询接口确认系统就绪

### 4.2 平台操作场景

1. **执行刚性支撑操作**
   - 上层应用发送刚性支撑请求，包含taskId和defectId
   - 系统验证参数有效性
   - 系统创建异步任务，返回任务信息
   - 系统执行刚性支撑操作
   - 操作完成后，更新任务状态
   - 上层应用可通过任务查询接口获取执行结果

2. **执行平台上升操作**
   - 上层应用发送平台上升请求，指定platformNum
   - 系统验证参数有效性
   - 系统创建异步任务，返回任务信息
   - 系统控制指定平台上升
   - 达到预设压力后自动停止
   - 更新任务状态为已完成
   - 上层应用可通过任务查询接口获取执行结果

3. **执行平台调平操作**
   - 上层应用发送平台调平请求
   - 系统验证参数有效性
   - 系统创建异步任务，返回任务信息
   - 系统读取当前倾角数据
   - 系统控制电动缸进行调平
   - 达到水平状态后完成操作
   - 更新任务状态
   - 上层应用可通过任务查询接口获取执行结果

### 4.3 异常处理场景

1. **参数验证失败**
   - 上层应用发送请求，但参数不完整或无效
   - 系统验证参数失败
   - 系统返回错误信息，指出具体错误原因
   - 上层应用根据错误信息修正请求

2. **操作执行异常**
   - 上层应用发送有效请求
   - 系统创建异步任务
   - 执行过程中遇到设备异常
   - 系统记录异常日志
   - 更新任务状态为失败，记录失败原因
   - 上层应用通过任务查询接口获知失败原因

3. **PLC通信异常**
   - 系统运行期间PLC通信中断
   - 系统记录通信异常日志
   - 系统自动尝试重连
   - 通信恢复后继续正常运行
   - 如果多次重连失败，系统进入安全模式

## 5. 系统接口定义

### 5.1 系统状态查询接口

**接口路径**：`/stability/health`  
**请求方法**：GET  
**响应格式**：JSON

**返回数据样例**：
```json
{
  "msg": "success",
  "status": "online",
  "version": "2.0",
  "timestamp": 1686532271000
}
```

### 5.2 系统信息查询接口

**接口路径**：`/stability/system/info`  
**请求方法**：GET  
**响应格式**：JSON

**返回数据样例**：
```json
{
  "msg": "success",
  "version": "2.0",
  "buildTime": "2024-03-11 12:00:00",
  "platform": "Ubuntu Server 24.04",
  "dependencies": {
    "cpprestsdk": "2.10.19",
    "nlohmann-json": "3.11.3",
    "spdlog": "1.9.2",
    "fmt": "9.1.0",
    "libmodbus": "3.1.10"
  },
  "plcHost": "192.168.1.10",
  "plcPort": 502
}
```

### 5.3 设备状态查询接口

**接口路径**：`/stability/device/state`  
**请求方法**：GET  
**响应格式**：JSON

**返回数据样例**：
```json
{
  "msg": "success",
  "operationMode": "自动",
  "emergencyStop": "复位",
  "oilPumpStatus": "启动",
  "cylinderState": "下降停止",
  "platform1State": "上升停止",
  "platform2State": "下降停止",
  "heaterStatus": "启动",
  "coolingStatus": "停止",
  "alarmStatus": "正常",
  "levelingStatus": "停止",
  "cylinderPressure": 12.34,
  "platform1Pressure": 5.67,
  "platform2Pressure": 5.78,
  "tiltAngle": 0.05,
  "platformPosition": 120,
  "timestamp": 1686532271000
}
```

### 5.4 支撑控制接口

**接口路径**：`/api/v1/control/support`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "taskId": 12345,
  "defectId": 67890,
  "state": "rigid"  // 或 "flexible"
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "taskId": 12345,
  "defectId": 67890,
  "state": "rigid",
  "timestamp": 1634567890123
}
```

### 5.5 平台高度控制接口

**接口路径**：`/api/v1/control/platform/height`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "taskId": 12345,
  "defectId": 67890,
  "platformNum": 1,  // 或 2
  "state": "up"  // 或 "down"
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "taskId": 12345,
  "defectId": 67890,
  "platformNum": 1,
  "state": "up",
  "timestamp": 1634567890123
}
```

### 5.6 平台调平控制接口

**接口路径**：`/api/v1/control/platform/horizontal`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "taskId": 12345,
  "defectId": 67890,
  "platformNum": 1,  // 或 2
  "state": "level"  // 或 "level_reset"
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "taskId": 12345,
  "defectId": 67890,
  "platformNum": 1,
  "state": "level",
  "timestamp": 1634567890123
}
```

### 5.7 电源控制接口

**接口路径**：`/api/v1/control/power`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "state": "on"  // 或 "off"
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "state": "on",
  "timestamp": 1634567890123
}
```

### 5.8 电机控制接口

**接口路径**：`/api/v1/control/motor`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "state": "start"  // 或 "stop"
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "state": "start",
  "timestamp": 1634567890123
}
```

### 5.9 操作模式接口

**接口路径**：`/api/v1/control/mode`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "mode": "auto"  // 或 "manual"
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "mode": "auto",
  "timestamp": 1634567890123
}
```

### 5.10 错误上报接口

**接口路径**：`/api/v1/report/error`  
**请求方法**：POST  
**请求格式**：JSON

**请求参数**：
```json
{
  "alarm": "液压系统压力异常",
  "level": "warning",  // 可选
  "source": "client",  // 可选
  "timestamp": 1634567890123  // 可选
}
```

**响应格式**：JSON

**成功响应样例**：
```json
{
  "msg": "success",
  "alarm": "液压系统压力异常",
  "timestamp": 1634567890123
}
```

## 6. 数据字典

### 6.1 状态字段定义

| 字段名 | 数据类型 | 说明 | 可能的值 |
|-------|---------|------|---------|
| operationMode | 字符串 | 操作模式 | "自动", "手动" |
| emergencyStop | 字符串 | 急停状态 | "复位", "急停" |
| oilPumpStatus | 字符串 | 油泵状态 | "停止", "启动" |
| cylinderState | 字符串 | 刚柔缸状态 | "下降停止", "下降加压", "上升停止", "上升" |
| platform1State | 字符串 | 升降平台1状态 | "上升", "上升停止", "下降", "下降停止" |
| platform2State | 字符串 | 升降平台2状态 | "上升", "上升停止", "下降", "下降停止" |
| heaterStatus | 字符串 | 电加热状态 | "停止", "启动" |
| coolingStatus | 字符串 | 风冷状态 | "停止", "启动" |
| alarmStatus | 字符串 | 报警状态 | "正常", "油温低", "油温高", "液位低", "液位高", "滤芯堵" |
| levelingStatus | 字符串 | 调平状态 | "停止", "启动" |

### 6.2 数值字段定义

| 字段名 | 数据类型 | 单位 | 说明 |
|-------|---------|------|------|
| cylinderPressure | 浮点数 | MPa | 刚柔缸压力值 |
| platform1Pressure | 浮点数 | MPa | 升降平台1压力值 |
| platform2Pressure | 浮点数 | MPa | 升降平台2压力值 |
| tiltAngle | 浮点数 | 度 | 平台倾斜角度 |
| platformPosition | 整数 | mm | 平台位置信息 |

### 6.3 操作参数定义

| 参数名 | 数据类型 | 说明 | 可接受的值 |
|-------|---------|------|-----------|
| taskId | 整数 | 任务ID | 大于0的整数 |
| defectId | 整数 | 缺陷ID | 大于0的整数 |
| platformNum | 整数 | 平台编号 | 1, 2 |
| state (支撑控制) | 字符串 | 支撑状态 | "rigid", "flexible" |
| state (平台高度) | 字符串 | 平台高度状态 | "up", "down" |
| state (平台调平) | 字符串 | 平台调平状态 | "level", "level_reset" |
| state (电源) | 字符串 | 电源状态 | "on", "off" |
| state (电机) | 字符串 | 电机状态 | "start", "stop" |
| mode | 字符串 | 操作模式 | "auto", "manual" |
| alarm | 字符串 | 报警信息 | 任意文本 |
| level | 字符串 | 报警级别 | "info", "warning", "error", "fatal" |
| source | 字符串 | 报警来源 | 任意文本 |

## 7. 约束条件

### 7.1 技术约束

1. **使用的技术栈**
   - 后端语言：C++17
   - Web框架：Microsoft C++ REST SDK (cpprestsdk)
   - PLC通信：libmodbus
   - 日志系统：spdlog
   - 配置解析：基于INI格式

2. **外部依赖**
   - PLC设备：支持Modbus TCP协议
   - 网络环境：支持TCP/IP

### 7.2 业务约束

1. **操作顺序约束**
   - 在执行刚性支撑前，平台必须已经处于上升停止状态
   - 在执行平台调平前，平台必须已经处于稳定状态

2. **安全约束**
   - 当检测到异常压力时，系统必须立即停止当前操作
   - 急停按钮被按下时，所有操作必须立即停止

### 7.3 资源约束

1. **系统资源**
   - CPU使用率不超过50%
   - 内存使用不超过2GB
   - 磁盘占用不超过1GB（含日志）

2. **网络资源**
   - PLC通信带宽需求：不超过1Mbps
   - API服务带宽需求：不超过10Mbps

## 8. 未来扩展计划

### 8.1 功能扩展

1. **用户管理与认证**
   - 添加用户登录和权限控制功能
   - 支持多级权限：管理员、操作员、观察者

2. **远程监控界面**
   - 开发基于Web的监控界面
   - 提供可视化数据展示和控制界面

3. **数据分析与诊断**
   - 添加历史数据存储和分析功能
   - 提供设备状态趋势分析和预警功能

### 8.2 性能扩展

1. **高并发支持**
   - 优化系统架构，支持更高并发请求
   - 实现任务队列和优先级管理

2. **分布式部署**
   - 支持多设备协同工作
   - 实现控制中心与现场设备分离部署

## 9. 验收标准

### 9.1 功能验收标准

1. **设备状态监控**
   - 能够准确显示所有设备状态和参数
   - 状态更新延迟不超过1秒

2. **平台控制功能**
   - 所有控制指令能够正确执行
   - 异步任务能够被正确创建和跟踪
   - 控制操作能够在设定条件下自动停止

3. **API接口**
   - 所有API接口按照规范返回正确格式的数据
   - 错误情况下返回明确的错误信息

### 9.2 非功能验收标准

1. **性能标准**
   - API响应时间符合性能需求
   - 系统能够同时处理指定数量的并发请求

2. **可靠性标准**
   - 系统连续运行24小时无故障
   - PLC通信中断后能够自动恢复
   - 异常情况下系统能够保持稳定

3. **安全标准**
   - 所有输入验证功能正常工作
   - 紧急停止功能能够立即响应

## 10. 附录

### 10.1 术语表

| 术语 | 定义 |
|------|------|
| PLC | 可编程逻辑控制器，用于控制工业设备 |
| Modbus TCP | 一种工业通信协议，用于PLC和计算机之间的通信 |
| 刚柔缸 | 能够提供刚性支撑和柔性复位的液压缸 |
| 升降平台 | 用于调整高度的液压平台 |
| 调平 | 使平台达到水平状态的过程 |
| API | 应用程序接口，提供系统服务的访问点 |
| 异步任务 | 不立即执行完成，在后台处理的任务 |

### 10.2 参考文档

1. PLC设备说明书
2. Modbus协议规范
3. C++ REST SDK文档
4. libmodbus库文档
5. 系统设计规范

### 10.3 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024-3-3 | 初始版本 | 苏伟杰 |
| 1.1 | 2024-3-5 | 添加平台2相关需求 | 苏伟杰 |
| 1.2 | 2024-3-10 | 更新API接口规范 | 苏伟杰 |
| 2.0 | 2024-3-11 | 完善文档结构，更新系统功能描述 | 苏伟杰 |

### 1.2 系统环境要求

- **操作系统**：Linux (Ubuntu 20.04/22.04)
- **开发环境**：GCC 9.0+ 或 Clang 10.0+
- **构建工具**：Make